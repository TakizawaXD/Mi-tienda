{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Tu Carrito de Compras</h1>
</div>

<div id="cart-container">
    <!-- El contenido del carrito se cargará aquí -->
</div>

<div id="cart-actions" class="mt-4" style="display: none;">
    <button class="btn btn-success" onclick="checkout()">Finalizar Compra</button>
</div>

<script>
    function loadCart() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            document.getElementById('cart-container').innerHTML = '<p>Debes <a href="/login-view">iniciar sesión</a> para ver tu carrito.</p>';
            return;
        }

        fetch('/cart', {
            headers: { 'Authorization': `Bearer ${token}` }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(cartItems => {
                const container = document.getElementById('cart-container');
                if (cartItems.length === 0) {
                    container.innerHTML = '<p>Tu carrito está vacío.</p>';
                    document.getElementById('cart-actions').style.display = 'none';
                    return;
                }

                let total = 0;
                let cartHtml = '<ul class="list-group">';
                cartItems.forEach(item => {
                    const itemTotal = item.product.price * item.quantity;
                    total += itemTotal;
                    cartHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h5>${item.product.name}</h5>
                                <p class="mb-0">Cantidad: ${item.quantity} x $${item.product.price.toLocaleString('es-CO')}</p>
                            </div>
                            <div>
                                <strong>$${itemTotal.toLocaleString('es-CO')}</strong>
                                <button class="btn btn-danger btn-sm ms-3" onclick="removeFromCart(${item.id})">Eliminar</button>
                            </div>
                        </li>
                    `;
                });
                cartHtml += `<li class="list-group-item d-flex justify-content-between align-items-center"><h4>Total</h4><strong>$${total.toLocaleString('es-CO')}</strong></li>`;
                cartHtml += '</ul>';
                container.innerHTML = cartHtml;
                document.getElementById('cart-actions').style.display = 'block';
            })
            .catch(error => {
                console.error('Error al cargar el carrito:', error);
                if (error.msg) {
                    alert('Tu sesión ha expirado. Por favor, inicia sesión de nuevo.');
                    window.location.href = '/login-view';
                }
            });
    }

    function removeFromCart(itemId) {
        const token = localStorage.getItem('access_token');
        fetch(`/cart/${itemId}`, { 
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        })
            .then(() => loadCart()); // Recargar el carrito
    }

    function checkout() {
        const token = localStorage.getItem('access_token');
        fetch('/cart/checkout', { 
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message || data.error);
                window.location.href = '/';
            });
    }

    document.addEventListener('DOMContentLoaded', loadCart);
</script>
{% endblock %}