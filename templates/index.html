{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Nuestros Productos</h1>
</div>

<div id="products-container" class="row">
    <!-- Los productos se cargarán aquí con JavaScript -->
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/products')
            .then(response => response.json())
            .then(products => {
                const container = document.getElementById('products-container');
                if (products.length === 0) {
                    container.innerHTML = '<p>No hay productos disponibles en este momento.</p>';
                    return;
                }
                products.forEach(product => {
                    const productCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card h-100">
                                <img src="${product.image}" class="card-img-top" alt="${product.name}" style="height: 200px; object-fit: cover;">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text">${product.description}</p>
                                    <p class="card-text"><strong>Precio:</strong> $${product.price.toLocaleString('es-CO')}</p>
                                    <p class="card-text"><small class="text-muted">Stock: ${product.stock}</small></p>
                                    <button class="btn btn-primary mt-auto" onclick="addToCart(${product.id})">Añadir al Carrito</button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += productCard;
                });
            });
    });

    function addToCart(productId) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('Debes iniciar sesión para añadir productos al carrito.');
            window.location.href = '/login-view';
            return;
        }

        fetch('/cart', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ product_id: productId, quantity: 1 })
        })
        .then(response => {
            if (!response.ok) {
                // Si la respuesta no es 2xx, la lanzamos como un error para que la capture el .catch()
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            alert('¡Producto añadido al carrito!');
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.msg) { // Error específico de JWT (ej. token expirado)
                alert('Tu sesión ha expirado. Por favor, inicia sesión de nuevo.');
                window.location.href = '/login-view';
            }
        });
    }
</script>
{% endblock %}